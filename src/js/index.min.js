$(document).ready(function () {
    console.warn('Page loaded!');
    $('.thumbail-preview').css('display', 'none');
    $('.modelwrap').css('display', 'block');

    let response = true;
    let colors = [60, 66, 65, 55, 56, 63, 69, 21, 22, 23, 29, 81, 89, 40, 41, 99, 61, 78];

    // $('#position').val('CTM');
    disableMessage();
    getAllColors();

    function getAllColors() {
        colors.forEach(img => {
            $('#color').append('<option value="' + img + '">' + img + '</option>');
        })
    }

    $('#submit-button').click(function () {
        if ($('#monograme').val().length) {
            if ($('.font').val().length) {
                if ($('#position').val().length) {
                    if ($('#color').val().length) {

                        let monograme = $('#monograme').val().replace(/\r?\n/g, '||');
                        $.ajax({
                            url: 'http://localhost:1880/broidery_order?m=' + monograme + '&f=' + $('.font').val() + '&c=' + $('#color').val(),
                            type: 'GET',
                            success: function (data) {
                                if ($('#position').val() == 'CTM' && $('#monograme').val().length > 3) response = false;


                                if (response) {
                                    $('#thumbail-index').attr('src', 'data:image/png;base64, ' + data.imagine);

                                    showElements();

                                    console.log(`${$('#position').val()}`);
                                    if ($('#model_debug').val().length > 0) showBackgroundImg($('#position').val(), $('#model_debug').val());
                                    else if ($('#model_debug_2').val().length > 0) showBackgroundImg($('#position').val(), $('#model_debug_2').val());

                                    disableMessage();
                                    response = true;
                                }
                                else showMessageError("Length of text are invalid. The maximum length is 3 characters, eg. ABC.");
                            }
                        })
                    }
                    else showMessageError("You don't select Color text!");
                }
                else showMessageError("You don't select Position text!");
            }
            else showMessageError("You don't select Font text!");
        }
        else showMessageError("You don't inserted Monograme text!");
    })

    /* Create background img for broidery simulator */
    function showBackgroundImg(type, img) {
        if (type == "CTM") $('.thumbail-preview').css('background-image', 'url("https://b2b2.formens.ro/img/optionssetari/VdoublA/' + img + '.jpg")');
        else $('.thumbail-preview').css('background-image', 'url("https://b2b2.formens.ro/img/optionssetari/Vguler/' + img + '.png")');
        $('.thumbail-preview').css('background-repeat', 'no-repeat');
        $('.thumbail-preview').css('width', "100%");
        $('.thumbail-preview').css('background-size', 'cover');
    }

    function showElements() {
        $('.thumbail-preview').css('display', 'flex');
    }

    function disableMessage() {
        $('.alert-msg').css('display', 'none');
    }

    /* Like bootstrap alert. */
    function showMessageError(input) {

        if (input.length) {
            $('.alert-msg').css('display', 'flex');
            $('.alert-msg').text(input);
        }
        response = true;
        console.log("showMessageError called!");
    }

    $('#position').click(function (e) {
        console.log("CLICK ", $('#position').val());
        $('#model').empty();


        // if($('#position').val() == "CTM") getModels("CTM");
        // else getModels();
    })

    function showFontLikeImg() {
        function custom_template(obj) {
            var data = $(obj.element).data();
            var text = $(obj.element).text();
            if (data && data['img_src']) {
                img_src = data['img_src'];
                template = $("<div><img src=\"" + img_src + "\" style=\"width:55%;height:10px;\"/></div>");
                return template;
            }
        }
        var options = {
            'templateSelection': custom_template,
            'templateResult': custom_template,
        }
        $('#id_select2_example').select2(options);
        $('.select2-container--default').css({ 'height': '50px' });
        console.log(template);
    }

    $(document).keypress(function (e) {
        let keyCode = (e.keyCode ? e.keyCode : e.keyCode)
        if ($('#monograme').is(':focus')) console.log('FOCUS on textarea'); // prevent Enter to execute click when you are in textarea input
        else if (keyCode == "13") $('#submit-button').click();
    })

    showFontLikeImg();
})

