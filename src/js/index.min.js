$(document).ready(function () {
    console.warn('Page loaded!');
    $('.thumbail-preview').css('display', 'none');
    $('.modelwrap').css('display', 'block');
    let response = true,
        font = '',
        monogrames = '',
        color = '';

    // $('#position').val('CTM');

    disableMessage();
    $('#submit-button').click(function () {
        func = function () {
            if ($('#monograme').val().length) {
                if ($('.font').val().length) {
                    if ($('#position').val().length) {
                        if ($('#color').val().length) {

                            // Creeaza mai multe lini la monograma.. de text. 
                            let monogrameLines = $('#monograme').val().replace(/\r?\n/g, '||');
                            $.ajax({
                                url: 'http://localhost:1880/broidery_order?m=' + monogrameLines + '&f=' + $('.font').val() + '&c=' + $('#color').val(),
                                type: 'GET',
                                success: function (data) {
                                    if ($('#position').val() == 'CTM' && $('#monograme').val().length > 3) response = false;

                                    // Daca sunt mai mult de 3 caractere la CTM, nu se executa cumanda.
                                    if (response) {
                                        $('#thumbail-index').attr('src', 'data:image/png;base64, ' + data.imagine);

                                        showElements();

                                        console.log(`${$('#position').val()}`);

                                        if ($('#position').val() == "CTM" || $('#position').val() == "CIM" || $('#position').val() == "CDM") {
                                            if ($('#model_debug').val().length > 0) showBackgroundImg($('#position').val(), $('#model_debug').val()); // some chnage
                                        } else {
                                            if ($('#model_debug_2').val().length > 0) showBackgroundImg($('#position').val(), $('#model_debug_2').val());
                                        }

                                        font = $('.font').val();
                                        color = $('#color').val();
                                        monogrames = $('#monograme').val();
                                        console.log("TX font value from response ", font, color, monogrames);

                                        disableMessage();
                                        response = true;
                                    }
                                    else showMessageError("Length of text are invalid. The maximum length is 3 characters at CTM, eg. ABC.");
                                }
                            })
                        }
                        else showMessageError("Color text are invalid or are not selected!");
                    }
                    else showMessageError("Position text are invalid or are not selected!");
                }
                else showMessageError("Please select the font!");
            }
            else showMessageError("WARN: Please insert the monograme text!");
        }
        func();
    })

    // setInterval(() => {
    //     if(font != '' || color != '') {
    //         if(font != $('.font').val() || color != $('#color').val() || monograme != $('#monograme').val()) checkSomeChanges();  
    //         console.log("FIRST ", font, color, monograme);  
    //         console.log("Second ", $('.font').val(), $('#color').val(), $('#monograme').val());
    //     }
    // }, 1000);


    /* Create background img for broidery simulator */ // Need some changes here
    function showBackgroundImg(type, img) {
        if (type == "CTM" || type == "CIM" || type == "CDM") $('.thumbail-preview').css('background-image', 'url("https://b2b2.formens.ro/img/optionssetari/VdoublA/' + img + '.jpg")');
        else $('.thumbail-preview').css('background-image', 'url("https://b2b2.formens.ro/img/optionssetari/Vguler/' + img + '.png")');
        $('.thumbail-preview').css('background-repeat', 'no-repeat');
        $('.thumbail-preview').css('width', "100%");
        $('.thumbail-preview').css('background-size', 'cover');
    }

    setInterval(() => {
        checkSomeChanges();
    }, 2000);

    // If are changes on monograme, font or color, image disappear; check at every 2 seconds 
    function checkSomeChanges() {
        if(color != '') if(color != $('#color').val()) $('.thumbail-preview').css('display', "none");
        else if(font != '') if(font != $('.font').val()) $('.thumbail-preview').css('display', "none"); 
        else if(monogrames != '') if(monogrames != $('#monograme').val()) $('.thumbail-preview').css('display', "none"); monograme = '';     
    }

    function showElements() {
        $('.thumbail-preview').css('display', 'flex');
    }

    function disableMessage() {
        $('.alert-msg').css('display', 'none');
    }

    /* Like bootstrap alert. */
    function showMessageError(input) {

        if (input.length) {
            $('.alert-msg').css('display', 'flex');
            $('.alert-msg').text(input);
        }
        response = true;
        console.log("showMessageError called!");

        setTimeout(disableMessage, 10000);
    }

    $('#position').click(function (e) {
        console.log("CLICK ", $('#position').val());
        $('#model').empty();

        // showFontLikeImg();
        // func(); // auto change background img

        // if($('#position').val() == "CTM") getModels("CTM");
        // else getModels();
    })

    function showFontLikeImg() {
        function custom_template(obj) {
            var data = $(obj.element).data();
            var text = $(obj.element).text();
            if (data && data['img_src']) {
                img_src = data['img_src'];
                template = $("<div><img src=\"" + img_src + "\" style=\"width:60%;height:15px;\"/></div>");
                return template;
            }
        }
        var options = {
            'templateSelection': custom_template,
            'templateResult': custom_template,
        }
        $('#id_select2_example').select2(options);
        $('.select2-container--default').css({ 'height': '50px' });
        console.log(template);
    }

    $(document).keypress(function (e) {
        let keyCode = (e.keyCode ? e.keyCode : e.keyCode)
        if ($('#monograme').is(':focus')) monogrames = 'Some' // prevent Enter to execute click when you are in textarea input
        else if (keyCode == "13") $('#submit-button').click();
    })

    $("#color").select2({
        templateResult: formatState
    });

    let icons = {
        "60": "/images/B/60.jpg",
        "66": "/images/B/66.jpg",
        "65": "/images/B/65.jpg",
        "55": "/images/B/55.jpg",
        "56": "/images/B/56.jpg",
        "63": "/images/B/63.jpg",
        "69": "/images/B/69.jpg",
        "21": "/images/B/21.jpg",
        "22": "/images/B/22.jpg",
        "23": "/images/B/23.jpg",
        "29": "/images/B/29.jpg",
        "81": "/images/B/81.jpg",
        "89": "/images/B/89.jpg",
        "40": "/images/B/40.jpg",
        "41": "/images/B/41.jpg",
        "99": "/images/B/99.jpg",
        "61": "/images/B/61.jpg",
        "78": "/images/B/78.jpg"
    }

    function formatState(state) {
        if (!state.id) { return state.text; }
        console.log(state);
        var $state = $(
            `
            <div style="display: flex; align-items: center;">
                <div><img sytle="display: flex" src="${icons[state.text]}" style="height: 150px; width: auto;" /></div>
                <div style="margin-left: 10px;">
                    ${state.text}
                </div>
            </div>
            `
        );
        return $state;
    }
    showFontLikeImg();
})

